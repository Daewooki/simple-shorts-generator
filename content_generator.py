"""
Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
"""

import json
import google.generativeai as genai


# ì½˜í…ì¸  ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
PROMPTS = {
    "quote": """
ë‹¹ì‹ ì€ ëª…ì–¸ íë ˆì´í„°ì…ë‹ˆë‹¤. ìœ íŠœë¸Œ ìˆì¸ ìš© 'ì˜¤ëŠ˜ì˜ ëª…ì–¸' ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{{
    "intro_title": "ì˜¤ëŠ˜ì˜ ëª…ì–¸",
    "slides": [
        {{
            "main_text": "ëª…ì–¸ ì›ë¬¸ (í•œêµ­ì–´)",
            "sub_text": "- ëª…ì–¸ì„ ë‚¨ê¸´ ì‚¬ëŒ"
        }},
        {{
            "main_text": "ì´ ëª…ì–¸ì˜ ì˜ë¯¸ë¥¼ 2-3ì¤„ë¡œ ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…",
            "sub_text": ""
        }},
        {{
            "main_text": "ì˜¤ëŠ˜ í•˜ë£¨ ì´ ëª…ì–¸ì„ ë˜ìƒˆê¸°ë©°\\nì‹¤ì²œí•´ë³´ì„¸ìš” ğŸ’ª",
            "sub_text": ""
        }}
    ],
    "outro_text": "ë‚´ì¼ë„ ì¢‹ì€ ëª…ì–¸ìœ¼ë¡œ ì°¾ì•„ì˜¬ê²Œìš”!"
}}

ì£¼ì˜ì‚¬í•­:
- ìœ ëª…í•˜ê³  ê°ë™ì ì¸ ëª…ì–¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”
- ìŠ¬ë¼ì´ë“œì˜ í…ìŠ¤íŠ¸ëŠ” ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ
- ê° ìŠ¬ë¼ì´ë“œ main_textëŠ” ìµœëŒ€ 60ì ì´ë‚´
""",

    "english": """
ë‹¹ì‹ ì€ ì˜ì–´ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ìœ íŠœë¸Œ ìˆì¸ ìš© 'ì˜¤ëŠ˜ì˜ ì˜ì–´' ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{{
    "intro_title": "ì˜¤ëŠ˜ì˜ ì˜ì–´",
    "slides": [
        {{
            "main_text": "ì˜ì–´ í‘œí˜„/ë¬¸ì¥",
            "sub_text": "ë°œìŒ ê°€ì´ë“œ (í•œê¸€ë¡œ)"
        }},
        {{
            "main_text": "í•œêµ­ì–´ ëœ»",
            "sub_text": "í•µì‹¬ í¬ì¸íŠ¸ í•œ ì¤„"
        }},
        {{
            "main_text": "ì˜ˆë¬¸ 1 (ì˜ì–´)\\nâ†’ í•œêµ­ì–´ í•´ì„",
            "sub_text": ""
        }},
        {{
            "main_text": "ì˜ˆë¬¸ 2 (ì˜ì–´)\\nâ†’ í•œêµ­ì–´ í•´ì„",
            "sub_text": ""
        }}
    ],
    "outro_text": "ë§¤ì¼ í•˜ë‚˜ì”©! ì˜ì–´ ì‹¤ë ¥ UP! ğŸš€"
}}

ì£¼ì˜ì‚¬í•­:
- ì‹¤ìƒí™œì—ì„œ ìì£¼ ì“°ì´ëŠ” í‘œí˜„ì„ ì„ íƒí•´ì£¼ì„¸ìš”
- ì›ì–´ë¯¼ì´ ì‹¤ì œë¡œ ë§ì´ ì‚¬ìš©í•˜ëŠ” í‘œí˜„
- ê° ìŠ¬ë¼ì´ë“œ main_textëŠ” ìµœëŒ€ 60ì ì´ë‚´
""",

    "knowledge": """
ë‹¹ì‹ ì€ êµì–‘ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìœ íŠœë¸Œ ìˆì¸ ìš© 'ì˜¤ëŠ˜ì˜ ìƒì‹' ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{{
    "intro_title": "ì˜¤ëŠ˜ì˜ ìƒì‹",
    "slides": [
        {{
            "main_text": "í¥ë¯¸ë¥¼ ë„ëŠ” ì§ˆë¬¸ í˜•íƒœì˜ ì œëª©",
            "sub_text": "ì•Œê³  ê³„ì…¨ë‚˜ìš”? ğŸ¤”"
        }},
        {{
            "main_text": "í•µì‹¬ ì‚¬ì‹¤/ì •ë³´ ì„¤ëª… (2-3ì¤„)",
            "sub_text": ""
        }},
        {{
            "main_text": "ì¶”ê°€ ì¬ë¯¸ìˆëŠ” ì‚¬ì‹¤ ë˜ëŠ” ê¿€íŒ",
            "sub_text": ""
        }}
    ],
    "outro_text": "ë§¤ì¼ ìƒˆë¡œìš´ ìƒì‹! ë‚´ì¼ë„ ë§Œë‚˜ìš” ğŸ“š"
}}

ì£¼ì˜ì‚¬í•­:
- í¥ë¯¸ë¡­ê³  ë†€ë¼ìš´ ì‚¬ì‹¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”
- ê³¼í•™, ì—­ì‚¬, ì‹¬ë¦¬, ìƒí™œ ë“± ë‹¤ì–‘í•œ ë¶„ì•¼ì—ì„œ
- ê° ìŠ¬ë¼ì´ë“œ main_textëŠ” ìµœëŒ€ 60ì ì´ë‚´
""",

    "motivation": """
ë‹¹ì‹ ì€ ë¼ì´í”„ ì½”ì¹˜ì…ë‹ˆë‹¤. ìœ íŠœë¸Œ ìˆì¸ ìš© 'ì˜¤ëŠ˜ì˜ ë™ê¸°ë¶€ì—¬' ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{{
    "intro_title": "ì˜¤ëŠ˜ì˜ ë™ê¸°ë¶€ì—¬",
    "slides": [
        {{
            "main_text": "ê°•ë ¬í•œ ë™ê¸°ë¶€ì—¬ ë©”ì‹œì§€ (1-2ì¤„)",
            "sub_text": ""
        }},
        {{
            "main_text": "êµ¬ì²´ì ì¸ ì‹¤ì²œ ë°©ë²•ì´ë‚˜ ì‚¬ë¡€ (2-3ì¤„)",
            "sub_text": ""
        }},
        {{
            "main_text": "ì˜¤ëŠ˜ë¶€í„° ì‹œì‘í•˜ì„¸ìš”!\\në‹¹ì‹ ì€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ”¥",
            "sub_text": ""
        }}
    ],
    "outro_text": "í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”! ë‚´ì¼ë„ ì‘ì›í• ê²Œìš” ğŸ’ª"
}}

ì£¼ì˜ì‚¬í•­:
- ì§„ë¶€í•˜ì§€ ì•Šì€ ì‹ ì„ í•œ ë©”ì‹œì§€
- ì‹¤ì œë¡œ í–‰ë™ìœ¼ë¡œ ì˜®ê¸¸ ìˆ˜ ìˆëŠ” ë‚´ìš©
- ê° ìŠ¬ë¼ì´ë“œ main_textëŠ” ìµœëŒ€ 60ì ì´ë‚´
""",

    "custom": """
ë‹¹ì‹ ì€ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤. ìœ íŠœë¸Œ ìˆì¸ ìš© '{topic}' ê´€ë ¨ ì½˜í…ì¸ ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš” (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
{{
    "intro_title": "ì ì ˆí•œ ì¸íŠ¸ë¡œ ì œëª©",
    "slides": [
        {{
            "main_text": "ì²« ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸",
            "sub_text": "ë³´ì¡° ì„¤ëª… (ì„ íƒ)"
        }},
        {{
            "main_text": "ë‘ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸",
            "sub_text": "ë³´ì¡° ì„¤ëª… (ì„ íƒ)"
        }},
        {{
            "main_text": "ì„¸ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸ ë˜ëŠ” ìš”ì•½",
            "sub_text": "ë³´ì¡° ì„¤ëª… (ì„ íƒ)"
        }}
    ],
    "outro_text": "ì ì ˆí•œ ë§ˆë¬´ë¦¬ ë©”ì‹œì§€"
}}

ì£¼ì˜ì‚¬í•­:
- '{topic}' ì£¼ì œì— ë§ëŠ” ìœ ìµí•œ ì •ë³´ë¥¼ ì „ë‹¬
- ìŠ¬ë¼ì´ë“œëŠ” 2~4ê°œ ì‚¬ì´ë¡œ êµ¬ì„±
- ê° ìŠ¬ë¼ì´ë“œ main_textëŠ” ìµœëŒ€ 60ì ì´ë‚´
- ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ í™œìš©
""",
}


def generate_content(api_key: str, content_type: str, model_name: str = "gemini-2.0-flash", topic: str = None) -> dict:
    """
    Gemini APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆì¸  ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    
    Args:
        api_key: Gemini API í‚¤
        content_type: ì½˜í…ì¸  ìœ í˜• (quote, english, knowledge, motivation, custom)
        model_name: ì‚¬ìš©í•  Gemini ëª¨ë¸
        topic: ì»¤ìŠ¤í…€ ì£¼ì œ (content_typeì´ "custom"ì¼ ë•Œ ì‚¬ìš©)
    
    Returns:
        ìƒì„±ëœ ì½˜í…ì¸  ë”•ì…”ë„ˆë¦¬
    """
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel(model_name)

    # í”„ë¡¬í”„íŠ¸ ì„ íƒ
    prompt = PROMPTS.get(content_type, PROMPTS["custom"])
    if content_type == "custom" and topic:
        prompt = prompt.replace("{topic}", topic)
    elif content_type == "custom":
        prompt = prompt.replace("{topic}", "í¥ë¯¸ë¡œìš´ ì •ë³´")

    print(f"ğŸ¤– Geminiì—ê²Œ '{content_type}' ì½˜í…ì¸  ìš”ì²­ ì¤‘...")
    
    response = model.generate_content(
        prompt,
        generation_config=genai.types.GenerationConfig(
            temperature=0.9,
            max_output_tokens=1024,
        ),
    )

    # JSON íŒŒì‹±
    raw_text = response.text.strip()
    
    # ```json ... ``` ë¸”ë¡ ì œê±°
    if raw_text.startswith("```"):
        lines = raw_text.split("\n")
        raw_text = "\n".join(lines[1:])  # ì²« ì¤„ ì œê±°
        if raw_text.endswith("```"):
            raw_text = raw_text[:-3]
        raw_text = raw_text.strip()

    try:
        content = json.loads(raw_text)
    except json.JSONDecodeError as e:
        print(f"âš ï¸  JSON íŒŒì‹± ì‹¤íŒ¨, ì¬ì‹œë„í•©ë‹ˆë‹¤... ({e})")
        # ì¬ì‹œë„: ë” ëª…í™•í•œ ì§€ì‹œ ì¶”ê°€
        retry_prompt = prompt + "\n\nì¤‘ìš”: ë°˜ë“œì‹œ ìœ íš¨í•œ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”. ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”."
        response = model.generate_content(retry_prompt)
        raw_text = response.text.strip()
        if raw_text.startswith("```"):
            lines = raw_text.split("\n")
            raw_text = "\n".join(lines[1:])
            if raw_text.endswith("```"):
                raw_text = raw_text[:-3]
            raw_text = raw_text.strip()
        content = json.loads(raw_text)

    print(f"âœ… ì½˜í…ì¸  ìƒì„± ì™„ë£Œ!")
    return content
